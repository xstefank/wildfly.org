<!DOCTYPE html>
<html>

<head>
  <script id="adobe_dtm" src="//www.redhat.com/dtm.js" type="text/javascript"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Configuring WildFly S2I image by using CLI Management Operations</title>
  <meta name="description" content="">
  <link rel="me" href="https://fosstodon.org/@wildflyas" />
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-40221748-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-40221748-1');
  </script>


</head>

<body class="Configuring WildFly S2I image by using CLI Management Operations">
  <div class="content">
    <div class="header navigation">
  <div class="logo-wrapper">
    <a href="/"><img class="wf-logo" src="/assets/img/wildfly_icons_one-color-logo.png"></a>
  </div>
  <div class="nav-container">
    <nav>
      <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
      <ul class="nav-list">
        <li>
          <a href="/" class="">Home</a>
        </li>
        <li>
          <a href="/downloads/" class="">Downloads</a>
        </li>
        <li>
          <a href="/news/" class="active">News</a>
        </li>
        <li>
          <a href="/about/" class="">About</a>
        </li>
        <li>
          <a href="/contribute/" class="">Contribute</a>
        </li>
        <li>
            <a target="_blank" href="https://docs.wildfly.org">Docs</a>
        </li>
        <li>
          <a class="button-cta secondary" href="https://github.com/wildfly/wildfly/fork" target="_blank">Fork</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

    <div class="post-page grid-wrapper">
  <div class="grid__item width-10-12">
    <h1 class="title">Configuring WildFly S2I image by using CLI Management Operations</h1>
    
    <p class="byline">By Yeray Borges | April 13, 2020</p>
  </div>
  <div class="grid__item width-10-12 doc-content">
    <div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The standard and recommended way to configure the WildFly cloud images is by using environment variables. However, you could find it useful for your use case to configure the server by using a custom CLI <a href="https://docs.wildfly.org/19/Admin_Guide.html#operations">management operations</a> script.</p>
</div>
<div class="paragraph">
<p>The following post describes how you can apply management operations to configure the WildFly server image. We will show you how you can execute CLI scripts at the <a href="https://github.com/openshift/source-to-image">Source-to-Image (S2I)</a> phase and how to use the extensions mechanism provided by the WildFly cloud image to execute CLI management operations at runtime.</p>
</div>
<div class="paragraph">
<p>This practical guide uses <a href="https://github.com/code-ready/crc">Red Hat CodeReady Containers</a> as a local OpenShift cluster. It assumes you have basic knowledge of OpenShift and you know how to configure the WildFly S2I image by using environment variables.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="executing-a-cli-management-operations-script-at-the-source-to-image-s2i-phase">Executing a CLI management operations script at the Source-to-Image (S2I) phase</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Source-to-Image is the tool used internally by OpenShift to build container images from application source code. When we are creating an OpenShift new application using the WildFly image stream, S2I takes our application source code from a Git repository, provisions the WildFly server by using Galleon layers and builds the final image that runs the assembled application.</p>
</div>
<div class="paragraph">
<p>In this example we are going to assemble this <a href="https://github.com/yersan/jaxrs-postgresql-demo">JAX-RS PostgreSQL</a> demo application with the WildFly server provisioned by Galleon with the PostgreSQL drivers. Our demo application expects a data source available under the following <code>java:jboss/datasources/PostgreSQLDS</code> JNDI resource. This data source will be configured executing the following <a href="https://github.com/yersan/jaxrs-postgresql-demo/blob/cli-at-s2i/s2i-config/config-ds.cli">config-ds.cli</a> CLI script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">data-source add --jndi-name=java:/jboss/datasources/PostgreSQLDS \
    --name=PostgreSQLPool \
    --connection-url=jdbc:postgresql://database-server:5432/demodb \
    --driver-name=postgresql \
    --user-name=postgre \
    --password=admin</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can take a look at <a href="https://wildfly.org/news/2019/11/11/WildFly-s2i-openshift-Datasource-configuration/">Configuring WildFly S2I image Datasources on OpenShift</a> post where it was explained how to configure a Datasource in WildFly S2I image using Galleon layers and environment variables.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="s2i-build-time-wildfly-server-customization-hooks-to-execute-a-cli-script">S2i build time WildFly server customization hooks to execute a CLI script</h3>
<div class="paragraph">
<p>The WildFly server customization hooks offer a way to execute a CLI script when your application is being assembled at S2I phase. To do so you have to configure the <code>S2I_IMAGE_SOURCE_MOUNTS</code> variable pointing out to the directory that will contain your configuration scripts. This directory is checked during S2I phase, and if an <strong>install.sh</strong> file is located in the root of the mount point, then this file is executed. This hook gives you the opportunity to execute any task you need to tweak the final image created by the S2I tool.</p>
</div>
<div class="paragraph">
<p>In our example, the <a href="https://github.com/yersan/jaxrs-postgresql-demo/blob/cli-at-s2i/s2i-config/install.sh">install.sh</a> file is located under <code>s2i-config</code> directory on our Git repository and we have <a href="https://github.com/yersan/jaxrs-postgresql-demo/blob/cli-at-s2i/.s2i/environment">S2I_IMAGE_SOURCE_MOUNTS</a> variable configured with this directory location relative to our Git repository root.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Notice you can set any S2I environment variables in the application source code. These variables are passed to the build, and the assemble script consumes them. All environment variables are also present in the output application image. These variables are defined in the <code>.s2i/environment</code> file inside the application sources. The format of this file is a simple key-value.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The content of our <strong>install.sh</strong> script is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash
source /usr/local/s2i/install-common.sh

injected_dir=$1
echo "Running on injected_dir=${injected_dir}"

run_cli_script "${injected_dir}/config-ds.cli"

echo "End CLI configuration"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The script is a regular bash file. It starts with sourcing <code>/usr/local/s2i/install-common.sh</code> file. This file is included in the WildFly S2I image and contains the following functions that can be used by the <strong>install.sh</strong> script to install and configure JBoss Modules modules, drivers, generic deployments and execute CLI scripts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>install_deployments</code>: Copy the file passed as an argument to the server deployment directory.</p>
</li>
<li>
<p><code>install_modules</code>: Copy all the JBoss Modules modules in the directory passed as argument to the server modules directory.</p>
</li>
<li>
<p><code>configure_drivers</code>: Configure the desired drivers using the environment file passed as an argument.</p>
</li>
<li>
<p><code>run_cli_script</code>: Execute the CLI script passed as an argument.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This <strong>install.sh</strong> script is invoked by the WildFly S2I image by passing it as an argument the location of the <code>S2I_IMAGE_SOURCE_MOUNTS</code> directory inside of the final image filesystem. You can use this argument to point out to other files or directories included in your application sources.</p>
</div>
<div class="paragraph">
<p>Behind the scenes <code>run_cli_script</code> will start the WildFly embedded server which will execute the CLI script file you supply as an argument to this function. In our example, we have passed the CLI script which is available at <code>"${injected_dir}/config-ds.cli"</code> inside of the assembled image.</p>
</div>
<div class="paragraph">
<p>If you need it, you can also create your CLI script on the fly when the <strong>install.sh</strong> is being executed so you can grab values for any <a href="https://docs.openshift.com/container-platform/4.2/builds/creating-build-inputs.html#builds-build-environment_creating-build-inputs">build environment variables</a> and use those values to tweak your script.</p>
</div>
<div class="paragraph">
<p>For example suppose we need to pass the data source username and password via environment variables. You can get them in the <strong>install.sh</strong> script and use their values when you are creating the CLI script file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash
source /usr/local/s2i/install-common.sh

injected_dir=$1
echo "Running on injected_dir=${injected_dir}"

# This creates the CLI file on the fly so you can grab env build config variables and use them in your script
echo "data-source add --jndi-name=java:/jboss/datasources/PostgreSQLDS \
    --name=PostgreSQLPool \
    --connection-url=jdbc:postgresql://database-server:5432/demodb \
    --driver-name=postgresql \
    --user-name=${DS_USERNAME} \
    --password=${DS_PASSWORD}" &gt; ${injected_dir}/my-script.cli

run_cli_script "${injected_dir}/my-script.cli"

echo "End CLI configuration"</code></pre>
</div>
</div>
<div class="paragraph">
<p>One advantage of configuring the server at S2I phase is you could gain speed when the server is being started at runtime. Your final image will be already configured by the <a href="https://docs.openshift.com/container-platform/4.2/builds/understanding-buildconfigs.html">OpenShift build config</a>. However, currently you cannot use the standard WildFly S2I environment variables at build time, and tweak the server configuration at this stage could break possible configurations done later by the environment variables at runtime.</p>
</div>
</div>
<div class="sect2">
<h3 id="test-the-application">Test the application</h3>
<div class="paragraph">
<p>The following commands shows you all the required steps to import the WildFly S2I image into CodeReady Containers, start the PostgreSQL server and assemble our demo application application that will execute the CLI script at S2I Phase.</p>
</div>
<div class="paragraph">
<p>First of all, start CodeReady Containers, import the WildFly image, create the wildfly-demo project and start the PostgreSQL server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ crc start
...
INFO Starting OpenShift cluster ... [waiting 3m]
INFO
INFO To access the cluster, first set up your environment by following 'crc oc-env' instructions
INFO Then you can access it by running 'oc login -u developer -p developer https://api.crc.testing:6443'
INFO To login as an admin, run 'oc login -u kubeadmin -p kKdPx-pjmWe-b3kuu-jeZm3 https://api.crc.testing:6443'
INFO
INFO You can now run 'crc console' and use these credentials to access the OpenShift web console
Started the OpenShift cluster
WARN The cluster might report a degraded or error state. This is expected since several operators have been disabled to lower the resource usage. For more information, please consult the documentation

$ oc login -u kubeadmin -p kKdPx-pjmWe-b3kuu-jeZm3 https://api.crc.testing:6443
Login successful.

You have access to 53 projects, the list has been suppressed. You can list all projects with 'oc projects'

Using project "default".

$ oc import-image wildfly --confirm \--from quay.io/wildfly/wildfly-centos7 --insecure -n openshift
imagestream.image.openshift.io/wildfly imported

$ oc new-project wildfly-demo
Now using project "wildfly-demo" on server "https://api.crc.testing:6443".

$ oc new-app --name database-server \
      --env POSTGRESQL_USER=postgre \
      --env POSTGRESQL_PASSWORD=admin \
      --env POSTGRESQL_DATABASE=demodb \
      postgresql
--&gt; Found image 40d2ad9 (2 months old) in image stream "openshift/postgresql" under tag "10" for "postgresql"

    PostgreSQL 10
    -------------
    PostgreSQL is an advanced Object-Relational database management system (DBMS). The image contains the client and server programs that you'll need to create, run, maintain and access a PostgreSQL DBMS server.

    Tags: database, postgresql, postgresql10, rh-postgresql10

    * This image will be deployed in deployment config "database-server"
    * Port 5432/tcp will be load balanced by service "database-server"
      * Other containers can access this service through the hostname "database-server"

--&gt; Creating resources ...
    imagestreamtag.image.openshift.io "database-server:10" created
    deploymentconfig.apps.openshift.io "database-server" created
    service "database-server" created
--&gt; Success
    Application is not exposed. You can expose services to the outside world by executing one or more of the commands below:
     'oc expose svc/database-server'
    Run 'oc status' to view your app.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let us create the OpenShift application from our JAX-RS PostgreSql demo application. We use the <code>cli-at-s2i</code> branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ oc new-app --name wildfly-app \
    https://github.com/yersan/jaxrs-postgresql-demo.git#cli-at-s2i \
    --image-stream=wildfly \
    --build-env GALLEON_PROVISION_LAYERS=jaxrs-server,postgresql-driver
--&gt; Found image bdf6490 (13 days old) in image stream "openshift/wildfly" under tag "latest" for "wildfly"

    WildFly 19.0.0.Final
    --------------------
    Platform for building and running JEE applications on WildFly 19.0.0.Final

    Tags: builder, wildfly, wildfly19

    * The source repository appears to match: jee
    * A source build using source code from https://github.com/yersan/jaxrs-postgresql-demo.git#cli-at-s2i will be created
      * The resulting image will be pushed to image stream tag "wildfly-app:latest"
      * Use 'oc start-build' to trigger a new build
    * This image will be deployed in deployment config "wildfly-app"
    * Ports 8080/tcp, 8778/tcp will be load balanced by service "wildfly-app"
      * Other containers can access this service through the hostname "wildfly-app"

--&gt; Creating resources ...
    imagestream.image.openshift.io "wildfly-app" created
    buildconfig.build.openshift.io "wildfly-app" created
    deploymentconfig.apps.openshift.io "wildfly-app" created
    service "wildfly-app" created
--&gt; Success
    Build scheduled, use 'oc logs -f bc/wildfly-app' to track its progress.
    Application is not exposed. You can expose services to the outside world by executing one or more of the commands below:
     'oc expose svc/wildfly-app'
    Run 'oc status' to view your app.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we have created the <code>wildfly-app</code> application, we can inspect the logs of the pod in charge of building the image where the S2I Phase took in place:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ oc get pods
NAME                       READY   STATUS      RESTARTS   AGE
database-server-1-deploy   0/1     Completed   0          4m36s
database-server-1-mj9z4    1/1     Running     0          4m25s
wildfly-app-1-build        0/1     Completed   0          3m38s
wildfly-app-1-deploy       0/1     Completed   0          58s
wildfly-app-1-dvnv6        1/1     Running     0          55s


$ oc logs wildfly-app-1-build
Caching blobs under "/var/cache/blobs".
Getting image source signatures
Copying blob sha256:ab5ef0e5819490abe86106fd9f4381123e37a03e80e650be39f7938d30ecb530
...
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 16.275 s
[INFO] Finished at: 2020-04-01T14:15:13Z
[INFO] Final Memory: 17M/112M
[INFO] ------------------------------------------------------------------------
[WARNING] The requested profile "openshift" could not be activated because it does not exist.
INFO Copying deployments from target to /deployments...
'/tmp/src/target/jaxrs-postgresql-demo.war' -&gt; '/deployments/jaxrs-postgresql-demo.war'
INFO Processing ImageSource mounts: s2i-config
INFO Processing ImageSource from /tmp/src/s2i-config
Running on injected_dir=/tmp/src/s2i-config
INFO Configuring the server using embedded server
INFO Duration: 4164 milliseconds
End CLI configuration
INFO Copying server to /s2i-output
...
Successfully pushed image-registry.openshift-image-registry.svc:5000/wildfly-demo/wildfly-app@sha256:6057c3bbc0a9071b102b4d0404f9592edebb0ef7c4dfbca9b00e50a2a117adcd
Push successful</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see in the log how the image source mount named <strong>s2i-config</strong> was processed, the value of the injected directory, in this case <strong>/tmp/src/s2i-config</strong>, which is a directory on the filesystem of the image being assembled, and a trace that tells us the server was configured by the embedded server.</p>
</div>
<div class="paragraph">
<p>Let us now check test the application exposing the application to the outside world and fetching some information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ oc expose svc/wildfly-app --name wildfly-app
route.route.openshift.io/wildfly-app exposed

$ curl http://$(oc get routes/wildfly-app --template={{.spec.host}})/jaxrs-postgresql-demo/api/tasks
[{"id":1,"title":"This is the task-1"},{"id":2,"title":"This is the task-2"},{"id":3,"title":"This is the task-3"},{"id":4,"title":"This is the task-4"},{"id":5,"title":"This is the task-5"}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also open a remote connection and inspect the relevant data source configuration:</p>
</div>
<div class="paragraph">
<p>The datasources subsystem configuration is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ oc rsh wildfly-app-1-dvnv6
sh-4.2$ cat /opt/wildfly/standalone/configuration/standalone.xml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:datasources:5.0"&gt;
    &lt;datasources&gt;
        &lt;datasource jndi-name="java:/jboss/datasources/PostgreSQLDS" pool-name="PostgreSQLPool"&gt;
            &lt;connection-url&gt;jdbc:postgresql://database-server:5432/demodb&lt;/connection-url&gt;
            &lt;driver&gt;postgresql&lt;/driver&gt;
            &lt;security&gt;
                &lt;user-name&gt;postgre&lt;/user-name&gt;
                &lt;password&gt;admin&lt;/password&gt;
            &lt;/security&gt;
        &lt;/datasource&gt;
        &lt;drivers&gt;
            &lt;driver name="postgresql" module="org.postgresql.jdbc"&gt;
                &lt;xa-datasource-class&gt;org.postgresql.xa.PGXADataSource&lt;/xa-datasource-class&gt;
            &lt;/driver&gt;
        &lt;/drivers&gt;
    &lt;/datasources&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now clean up the wildfly-app keeping the PostgreSQL server running, we will use it for the next example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ oc delete all -l app=wildfly-app
pod "wildfly-app-1-dvnv6" deleted
replicationcontroller "wildfly-app-1" deleted
service "wildfly-app" deleted
deploymentconfig.apps.openshift.io "wildfly-app" deleted
buildconfig.build.openshift.io "wildfly-app" deleted
build.build.openshift.io "wildfly-app-1" deleted
imagestream.image.openshift.io "wildfly-app" deleted</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-the-extension-mechanism-to-configure-the-server">Using the extension mechanism to configure the Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The extension mechanism allows the execution of arbitrary bash scripts before and after the server is configured by using environment variables. An interesting use case could be you want to tweak the server configuration after it has been configured by the environment variables, for example, there is a specific configuration that is not exposed directly by an environment variable.</p>
</div>
<div class="paragraph">
<p>When the server is launched at runtime, the <code>$JBOSS_HOME/extensions</code> directory on the image filesystem is examined to look for any of these two files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>$JBOSS_HOME/extensions/preconfigure.sh</code></p>
</li>
<li>
<p><code>$JBOSS_HOME/extensions/postconfigure.sh</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If <strong>preconfigure.sh</strong> exists, then it is executed as an initial step before configuring the server by using the environment variables. Similarly, once the server is configured, if <strong>postconfigure.sh</strong> exists, it is executed. Those specific scripts give you the opportunity to prepare the image for the server configuration and to execute any task once the server is configured.</p>
</div>
<div class="paragraph">
<p>In the following example we are going to use our <strong>postconfigure.sh</strong> to perform a datasource connection pool tuning configuring the following attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pool-use-strict-min</code>: This attribute specifies whether WildFly allows the number of connections in the pool to fall below the specified minimum.</p>
</li>
<li>
<p><code>idle-timeout-minutes</code>: This attribute specifies the maximum time, in minutes, a connection may be idle before being closed. As idle connections are closed, the number of connections in the pool will shrink down to the specified minimum.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Since we are going to supply our <strong>postconfigure.sh</strong> file in our application Git repository, we will use <strong>install.sh</strong> script to copy this file to the place expected by the WildFly S2I image so it gets executed when the server is launched.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>As alternative, in OpenShift you can also supply this file by using a config map mounted to <code>$JBOSS_HOME/extensions</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let us examine the content of our files. First, the <a href="https://github.com/yersan/jaxrs-postgresql-demo/blob/cli-extensions/s2i-config/install.sh">install.sh</a> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

injected_dir=$1

echo "Copy ${injected_dir}/extensions/postconfigure.sh to ${JBOSS_HOME}/extensions/"

mkdir -p "${JBOSS_HOME}/extensions/"
cp "${injected_dir}/extensions/postconfigure.sh" "${JBOSS_HOME}/extensions/"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Its content is pretty simple; it creates the <code>${JBOSS_HOME}/extensions/</code> if it does not exist yet, and copies our <strong>postconfigure.sh</strong> script.</p>
</div>
<div class="paragraph">
<p>Now let us look at the content of our <a href="https://github.com/yersan/jaxrs-postgresql-demo/blob/cli-extensions/s2i-config/extensions/postconfigure.sh">postconfigure.sh</a> script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/usr/bin/env bash

echo "Appending CLI operations to ${CLI_SCRIPT_FILE}"

echo "
  /subsystem=datasources/data-source=database_server-DATABASE_SERVER:write-attribute(name=pool-use-strict-min, value=true)
  /subsystem=datasources/data-source=database_server-DATABASE_SERVER:write-attribute(name=idle-timeout-minutes, value=5)
" &gt;&gt; "${CLI_SCRIPT_FILE}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can append CLI operations to the final CLI script used by the WildFly image. You can access this file through the environment variable <code>CLI_SCRIPT_FILE</code> which is available in this script environment.</p>
</div>
<div class="paragraph">
<p>The management operations executed in this script assume there is already a datasource named <code>database_server-DATABASE_SERVER</code>. This datasource will be created and configured by using the standard environment variables.</p>
</div>
<div class="sect2">
<h3 id="test-the-application-2">Test the application</h3>
<div class="paragraph">
<p>Assuming your database server is already configured as in our previous example, let us now create our OpenShift application using this time the <code>cli-extensions</code> branch and by passing in the environment variables that configure our data source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ oc new-app --name wildfly-app \
         https://github.com/yersan/jaxrs-postgresql-demo.git#cli-extensions  \
         --image-stream=wildfly \
         --env DATASOURCES=DATABASE_SERVER \
         --env DATABASE_SERVER_JNDI="java:/jboss/datasources/PostgreSQLDS" \
         --env DATABASE_SERVER_DATABASE="demodb" \
         --env DATABASE_SERVER_USERNAME="postgre" \
         --env DATABASE_SERVER_PASSWORD="admin" \
         --env DATABASE_SERVER_DRIVER="postgresql" \
         --env DATABASE_SERVER_MAX_POOL_SIZE=10 \
         --env DATABASE_SERVER_MIN_POOL_SIZE=5 \
         --env DATABASE_SERVER_NONXA=true \
         --build-env GALLEON_PROVISION_LAYERS=jaxrs-server,postgresql-driver
--&gt; Found image bdf6490 (13 days old) in image stream "openshift/wildfly" under tag "latest" for "wildfly"

    WildFly 19.0.0.Final
    --------------------
    Platform for building and running JEE applications on WildFly 19.0.0.Final

    Tags: builder, wildfly, wildfly19

    * The source repository appears to match: jee
    * A source build using source code from https://github.com/yersan/jaxrs-postgresql-demo.git#cli-extensions will be created
      * The resulting image will be pushed to image stream tag "wildfly-app:latest"
      * Use 'oc start-build' to trigger a new build
    * This image will be deployed in deployment config "wildfly-app"
    * Ports 8080/tcp, 8778/tcp will be load balanced by service "wildfly-app"
      * Other containers can access this service through the hostname "wildfly-app"

--&gt; Creating resources ...
    imagestream.image.openshift.io "wildfly-app" created
    buildconfig.build.openshift.io "wildfly-app" created
    deploymentconfig.apps.openshift.io "wildfly-app" created
    service "wildfly-app" created
--&gt; Success
    Build scheduled, use 'oc logs -f bc/wildfly-app' to track its progress.
    Application is not exposed. You can expose services to the outside world by executing one or more of the commands below:
     'oc expose svc/wildfly-app'
    Run 'oc status' to view your app.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let us explain a bit the uses of these environment variables. You could have noticed we have not defined how our application will connect to the database server since there is no environment variable defining the database server host name / IP or port</p>
</div>
<div class="paragraph">
<p>The <code>DATASOURCES</code> declaration defines the prefix for our data source, in this case the prefix is <code>DATABASE_SERVER</code>. By using this definition, the WildFly S2I configuration scripts will pick up the database host name and port from the following variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>&lt;PREFIX&gt;_SERVICE_HOST</p>
</li>
<li>
<p>&lt;PREFIX&gt;_SERVICE_PORT</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We have created a database server with the name <strong>database-server</strong>, which in turns created a service with the same name. Because of the existence of this service, when our application pod is started, OpenShift will initialize the following variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DATABASE_SERVER_SERVICE_HOST</p>
</li>
<li>
<p>DATABASE_SERVER_SERVICE_PORT</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The WildFly S2I scripts will take the database host IP and port from those variables and will create the datasource using their values.</p>
</div>
<div class="paragraph">
<p>You can verify the presence and the values of these variables executing a remote command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ oc get pods
NAME                       READY   STATUS      RESTARTS   AGE
database-server-1-deploy   0/1     Completed   0          46m
database-server-1-mj9z4    1/1     Running     0          46m
wildfly-app-1-build        0/1     Completed   0          23m
wildfly-app-1-deploy       0/1     Completed   0          20m
wildfly-app-1-sww2q        1/1     Running     0          20m

$ oc exec wildfly-app-1-sww2q -- env | grep "DATABASE_SERVER_SERVICE_PORT\|DATABASE_SERVER_SERVICE_HOST"
DATABASE_SERVER_SERVICE_PORT=5432
DATABASE_SERVER_SERVICE_HOST=172.30.142.21</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can check the data source subsystem configuration to verify it was configured as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ oc exec wildfly-app-1-sww2q -- cat /opt/wildfly/standalone/configuration/standalone.xml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:datasources:5.0"&gt;
    &lt;datasources&gt;
        &lt;datasource jta="true" jndi-name="java:/jboss/datasources/PostgreSQLDS" pool-name="database_server-DATABASE_SERVER" enabled="true" use-java-context="true" statistics-enabled="${wildfly.datasources.statistics-enabled:${wildfly.statistics-enabled:false}}"&gt;
            &lt;connection-url&gt;jdbc:postgresql://172.30.142.21:5432/demodb&lt;/connection-url&gt;
            &lt;driver&gt;postgresql&lt;/driver&gt;
            &lt;pool&gt;
                &lt;min-pool-size&gt;5&lt;/min-pool-size&gt;
                &lt;max-pool-size&gt;10&lt;/max-pool-size&gt;
                &lt;use-strict-min&gt;true&lt;/use-strict-min&gt;
            &lt;/pool&gt;
            &lt;security&gt;
                &lt;user-name&gt;postgre&lt;/user-name&gt;
                &lt;password&gt;admin&lt;/password&gt;
            &lt;/security&gt;
            &lt;validation&gt;
                &lt;valid-connection-checker class-name="org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLValidConnectionChecker"/&gt;
                &lt;validate-on-match&gt;true&lt;/validate-on-match&gt;
                &lt;background-validation&gt;false&lt;/background-validation&gt;
                &lt;exception-sorter class-name="org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLExceptionSorter"/&gt;
            &lt;/validation&gt;
            &lt;timeout&gt;
                &lt;idle-timeout-minutes&gt;5&lt;/idle-timeout-minutes&gt;
            &lt;/timeout&gt;
        &lt;/datasource&gt;
        &lt;drivers&gt;
            &lt;driver name="postgresql" module="org.postgresql.jdbc"&gt;
                &lt;xa-datasource-class&gt;org.postgresql.xa.PGXADataSource&lt;/xa-datasource-class&gt;
            &lt;/driver&gt;
        &lt;/drivers&gt;
    &lt;/datasources&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, delete the project created to clean up all the resources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ oc delete project wildfly-demo</code></pre>
</div>
</div>
</div>
</div>
</div>
  </div>
</div>



  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img class="wf-logo" src="/assets/img/wildfly_icons_one-color-logo.png"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">WildFly is open. All dependencies of this project are available under the <a href='https://www.gnu.org/licenses/old-licenses/lgpl-2.1.en.html' target='_blank'>LGPL 2.1</a> or compatible license.<br/><br/>This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/wildfly/wildfly.org/fork' target='_blank'>fork it</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <strong>Navigation</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="/downloads">Downloads</a></li>
          
            <li><a href="https://docs.wildfly.org">Docs</a></li>
          
            <li><a href="https://github.com/wildfly/wildfly">Github</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <strong>Contribute</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://issues.jboss.org/browse/WFLY">Submit a bug</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/wildfly">Join the forum</a></li>
          
            <li><a href="https://github.com/wildfly/wildfly/fork">Fork WildFly</a></li>
          
            <li><a href="https://twitter.com/WildFlyAS">Follow us</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <strong>Get Help</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://groups.google.com/forum/#!forum/wildfly">Join the forum</a></li>
          
            <li><a href="https://wildfly.zulipchat.com/">Join Zulip Chat</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-6-12 more-links">
        <strong>Find more Red Hat Middleware Community Projects</strong>
        <ul class="footer-links">
          
            <li><a href="https://www.apiman.io/">APIMan</a></li>
          
            <li><a href="http://arquillian.org">Arquillian</a></li>
          
            <li><a href="https://github.com/ansible-middleware/wildfly">Ansible Collection for Wildfly</a></li>
          
            <li><a href="http://byteman.jboss.org/">Byteman</a></li>
          
            <li><a href="http://capedwarf.org/">CapeDwarf</a></li>
          
            <li><a href="https://github.com/alechenninger/chronicler">Chronicler</a></li>
          
            <li><a href="https://github.com/darcy-framework">Darcy</a></li>
          
            <li><a href="http://debezium.io/">Debezium</a></li>
          
            <li><a href="https://www.drools.org/">Drools</a></li>
          
            <li><a href="http://gatein.jboss.org/">GateIn</a></li>
          
            <li><a href="http://www.hawkular.org/">Hawkular</a></li>
          
            <li><a href="http://hawt.io/">Hawtio</a></li>
          
            <li><a href="http://hibernate.org/">Hibernate</a></li>
          
            <li><a href="http://www.infinispan.org/">Infinispan</a></li>
          
            <li><a href="https://developers.redhat.com/products/codeready-studio/overview">CodeReady Studio</a></li>
          
            <li><a href="http://forge.jboss.org/">JBoss Forge</a></li>
          
            <li><a href="https://github.com/jboss-logging">JBoss Logging</a></li>
          
            <li><a href="http://jbossremoting.jboss.org/">JBoss Remoting</a></li>
          
            <li><a href="https://www.jbpm.org/">jBPM</a></li>
          
            <li><a href="https://jsfunit.jboss.org/">JSFUnit</a></li>
          
            <li><a href="https://www.keycloak.org/">Keycloak</a></li>
          
            <li><a href="http://modcluster.io/">Mod Cluster</a></li>
          
            <li><a href="http://modeshape.jboss.org/">ModeShape</a></li>
          
            <li><a href="https://www.optaplanner.org/">OptaPlanner</a></li>
          
            <li><a href="https://quarkus.io/">Quarkus</a></li>
          
            <li><a href="http://resteasy.jboss.org/">RESTEasy</a></li>
          
            <li><a href="https://riftsaw.jboss.org/">Riftsaw</a></li>
          
            <li><a href="http://savara.jboss.org/">Savara</a></li>
          
            <li><a href="https://weld.cdi-spec.org/">Weld</a></li>
          
            <li><a href="http://arquillian.org/">Shrinkwrap</a></li>
          
            <li><a href="http://snowdrop.jboss.org/">Snowdrop</a></li>
          
            <li><a href="https://switchyard.jboss.org/">Switchyard</a></li>
          
            <li><a href="https://tattletale.jboss.org/">Tattletale</a></li>
          
            <li><a href="http://teiid.jboss.org/">Teiid</a></li>
          
            <li><a href="https://wildfly-security.github.io/wildfly-elytron/">WildFly Elytron</a></li>
          
            <li><a href="https://thorntail.io/">Thorntail</a></li>
          
            <li><a href="http://wise.jboss.org/">Wise</a></li>
          
            <li><a href="https://xnio.jboss.org/">XNIO</a></li>
          
        </ul>
      </div>
    
  </div>
</div>
  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/img/redhat_reversed.svg"></a>
    </span>
  </div>
</div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/random-color-picker.js"></script>
  <script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
  </script>
</body>

</html>
