<!DOCTYPE html>
<html>

<head>
  <script id="adobe_dtm" src="//www.redhat.com/dtm.js" type="text/javascript"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WildFly 16 and Galleon, towards a cloud native EE application server</title>
  <meta name="description" content="">
  <link rel="me" href="https://fosstodon.org/@wildflyas" />
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-40221748-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-40221748-1');
  </script>


</head>

<body class="WildFly 16 and Galleon, towards a cloud native EE application server">
  <div class="content">
    <div class="header navigation">
  <div class="logo-wrapper">
    <a href="/"><img class="wf-logo" src="/assets/img/wildfly_icons_one-color-logo.png"></a>
  </div>
  <div class="nav-container">
    <nav>
      <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
      <ul class="nav-list">
        <li>
          <a href="/" class="">Home</a>
        </li>
        <li>
          <a href="/downloads/" class="">Downloads</a>
        </li>
        <li>
          <a href="/news/" class="active">News</a>
        </li>
        <li>
          <a href="/about/" class="">About</a>
        </li>
        <li>
          <a href="/contribute/" class="">Contribute</a>
        </li>
        <li>
            <a target="_blank" href="https://docs.wildfly.org">Docs</a>
        </li>
        <li>
          <a class="button-cta secondary" href="https://github.com/wildfly/wildfly/fork" target="_blank">Fork</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

    <div class="post-page grid-wrapper">
  <div class="grid__item width-10-12">
    <h1 class="title">WildFly 16 and Galleon, towards a cloud native EE application server</h1>
    
    <p class="byline">By Jean-François Denise | March 01, 2019</p>
  </div>
  <div class="grid__item width-10-12 doc-content">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This post has been co-authored with Jorge Morales and Josh Wood from the OpenShift Developer Advocacy Team.
Jorge is passionate about Developer experience, Java programming, and, most importantly,
improving the integration of Red Hat’s Middleware into the OpenShift platform. Josh is committed to
constructing the future of utility computing with open source technologies like Kubernetes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="problem-space">Problem space</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Containers are becoming the default deployment strategy for applications in the enterprise.
We’ve seen the software packaged in those containers adapt to this new deployment paradigm.
The WildFly team was an early adopter of container technology, driven by running our software on Red Hat’s OpenShift
Container Platform. However, only recently have we started adapting WildFly to take advantage of
the “<a href="https://opensource.com/article/18/7/what-are-cloud-native-apps">cloud-native</a>” features of
containers and platforms like Kubernetes and OpenShift, such as elasticity, scalability, and lifecycle automation.</p>
</div>
<div class="paragraph">
<p>We maintain a pair of WildFly container images. One is a <a href="https://github.com/jboss-dockerfiles/wildfly">classic container</a>
for Docker and other Open Container Image (OCI) compatible runtimes. <a href="https://github.com/openshift-s2i/s2i-wildfly">The second</a>
is a variant incorporating OpenShift’s <a href="https://github.com/openshift/source-to-image">Source-to-Image (s2i)</a>
mechanism to work with the platform’s build support. Both have been updated with each WildFly version since WildFly 8.</p>
</div>
<div class="paragraph">
<p>In that time, we’ve learned a lot about what’s needed to make WildFly and the WildFly container images
for OpenShift and Kubernetes more cloud-native&#8201;&#8212;&#8201;more able to take advantage of the facilities of the
environments where they run today. We’ve gathered feedback from many sources, including upstream
developers as well as enterprise end-users and customers, and we’ve tried to apply
their insight to our own experience.</p>
</div>
<div class="paragraph">
<p>One recurring theme we’ve heard about is image sizes. The size of a WildFly container
image is driven by these three factors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The size of the base layer, or <code>FROM</code> image, that typically provides the essential
Operating System user space including the runtimes needed for a Java application.</p>
</li>
<li>
<p>The size of the WildFly runtime added to the image.</p>
</li>
<li>
<p>The size of the application itself.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We can only control the second factor, the size of the WildFly runtime added to the image.
In this post, we introduce some experiments we’ve been working on, with the aim of producing
more “cloud-native” WildFly image for OpenShift or any other Kubernetes-based container platform</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="intro-to-galleon">Intro to Galleon</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://docs.wildfly.org/galleon/">Galleon</a> is a provisioning tool for working
with Maven repositories. Galleon automatically retrieves released WildFly Maven
artifacts to compose a software distribution of a WildFly-based application server
according to a user’s configuration. With no configuration, Galleon installs a complete
WildFly server. Users can express which configuration, such as standalone only,
or which set of features, such as web-server, jpa, jaxrs, cdi, etc., they want to install.</p>
</div>
<div class="sect2">
<h3 id="wildfly-galleon-layers">WildFly Galleon Layers</h3>
<div class="paragraph">
<p>Starting with <a href="http://wildfly.org/news/2019/02/27/WildFly16-Final-Released/">WildFly 16</a>,
we can use <a href="https://docs.wildfly.org/galleon/#_layers">Galleon layers</a> to control the set of
features present in a WildFly server. A Galleon layer identifies one or more server
features that can be installed on its own or in combination with other layers.
For example, if your application, some-microservice, makes use of only the jaxrs and
cdi server features, you can choose to install just the jaxrs and cdi layers.
The configuration in <code>standalone.xml</code> would then contain only the required subsystems and their dependencies.</p>
</div>
<div class="paragraph">
<p>If you want to follow along with the examples, <a href="https://github.com/wildfly/galleon/releases">download the latest Galleon command line tool</a>.</p>
</div>
<div class="paragraph">
<p>Using the <a href="http://docs.wildfly.org/galleon/#_galleon_cli_tool">Galleon cli tool</a>,
creating such a jaxrs and cdi-only server distribution would look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">galleon.sh install wildfly:current --layers=jaxrs,cdi --dir=my-wildfly-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command installs the jaxrs and cdi layers of the latest released version
of WildFly (wildfly:current argument) into the my-wildfly-server directory specified
in the --dir argument. The my-wildfly-server directory will contain only the artifacts needed to run your application.</p>
</div>
<div class="paragraph">
<p>Here’s a  list of commonly used layers. You can find a complete list of wildfly
layers in the <a href="http://docs.wildfly.org/16/Admin_Guide.html#defined-galleon-layers">WildFly Admin Guide</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>web-server</em>: Servlet container</p>
</li>
<li>
<p><em>cloud-profile</em>: Aggregates layers often required for cloud applications. jaxrs, cdi, jpa (hibernate), and jms (external broker connections)</p>
</li>
<li>
<p><em>core-server</em>: Aggregates management features (management, elytron, jmx, logging, and others)</p>
</li>
<li>
<p><em>core-tools</em>: Contains management tools (jboss-cli, add-user, and others)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To provision a lightweight microservice with the management features, run a command like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">galleon.sh install wildfly:current --layers=cloud-profile,core-server,core-tools --dir=my-wildfly-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>Galleon also defines an XML file to describe an installation in a fine-grained way.
The following <strong>provisioning.xml</strong> file provisions a WildFly server with support for jaxrs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;installation xmlns="urn:jboss:galleon:provisioning:3.0"&gt;
    &lt;feature-pack location="wildfly@maven(org.jboss.universe:community-universe):current"&gt;
        &lt;default-configs inherit="false"/&gt;
        &lt;packages inherit="false"/&gt;
    &lt;/feature-pack&gt;
    &lt;config model="standalone" name="standalone.xml"&gt;
        &lt;layers&gt;
            &lt;include name="jaxrs"/&gt;
        &lt;/layers&gt;
    &lt;/config&gt;
    &lt;options&gt;
        &lt;option name="optional-packages" value="passive+"/&gt;
    &lt;/options&gt;
&lt;/installation&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a nutshell, this file captures the following installation customizations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do not include default configurations.</p>
</li>
<li>
<p>Do not include all packages (JBoss Module modules and other content).</p>
</li>
<li>
<p>Generate a standalone.xml configuration that includes only the jaxrs layer.</p>
</li>
<li>
<p>Include only packages related to the jaxrs layer (option passive+).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using the Galleon CLI tool’s provision subcommand, we can  install from an XML provisioning file like the example above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">galleon.sh provision &lt;path to XML file&gt; --dir=my-wildfly-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>This asciinema recording shows these CLI commands in action, as well as the generated server content and image sizes.</p>
</div>
<script id="asciicast-230500" src="https://asciinema.org/a/230500.js" async></script>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-a-wildfly-server-with-openshift-builds">Creating a WildFly server with OpenShift builds</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By coupling OpenShift build features with Galleon, we can create customized images according to application requirements.</p>
</div>
<div class="sect2">
<h3 id="s2i-image-for-galleon">S2I image for Galleon</h3>
<div class="paragraph">
<p>For this demonstration, we built an <a href="https://github.com/jorgemoralespou/s2i-wildfly-galleon">S2I image</a>
that adds Galleon tools to the WildFly S2I image. When building your source code into this image,
both the application and server are built. The S2I build process looks for the presence of
a <strong>provisioning.xml</strong> file at the root of the application project. If it finds one,
it is used as input to Galleon to provision the server it defines. The S2I image has been
deployed on <a href="https://quay.io/repository/jorgemoralespou/s2i-wildfly-galleon">quay.io</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You must add <a href="https://github.com/jorgemoralespou/s2i-wildfly-galleon/blob/master/ose3/galleon-s2i-imagestream.yml">this image stream</a>
in OpenShift to continue following the example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">oc create -f https://raw.githubusercontent.com/jorgemoralespou/s2i-wildfly-galleon/master/ose3/galleon-s2i-imagestream.yml</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="two-build-stages-optimize-production-image-size">Two Build Stages Optimize Production Image Size</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this <a href="https://github.com/jorgemoralespou/s2i-wildfly-galleon/blob/master/ose3/galleon-s2i-template.yml">OpenShift template</a>
that automates the build and deployment, we’ve split the build to create 2 separate images:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A “development” image built from the Galleon S2I image. This is a “<strong>fat</strong>” image containing all of
the tooling to build the application (JDK, Maven, Galleon, …). This image is runnable, but it consumes a
larger amount of resources. We build it first to produce the artifacts we need for an optimized image intended for production.</p>
</li>
<li>
<p>A “production” image, built from JRE-8, into which the WildFly server and <code>.war</code> files are copied.
This image has a smaller footprint. It contains only the dependencies needed to run the WildFly server and the application.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The template creates a deployment for each image. The “development image” is the primary
deployment and scaled to 1 instance, the “production image” is a replica and scaled to 0
instances. When one wants to use the “production image”, this would need to be scaled to 1,
and the route will need to be balanced to this “production” deployment. To be conservative on
resources, the “development” deployment can be downscaled to 0.</p>
</div>
<div class="paragraph">
<p>You can add the template to your OpenShift project by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">oc create -f https://raw.githubusercontent.com/jorgemoralespou/s2i-wildfly-galleon/master/ose3/galleon-s2i-template.yml</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="building-the-development-image">Building the development image</h3>
<div class="paragraph">
<p>We use OpenShift’s s2i support to build the application. Note the <strong>s2i-wildfly-galleon:16.0.0.Final</strong>
image stream specified in this BuildConfig excerpt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">    source:
      git:
        ref: master
        uri: https://github.com/jorgemoralespou/s2i-wildfly-galleon
      contextDir: test/test-app-jaxrs
      type: Git
    strategy:
      sourceStrategy:
        from:
          kind: ImageStreamTag
          name: s2i-wildfly-galleon:16.0.0.Final
      type: Source</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once this build is complete, the server is installed in <strong>/output/wildfly</strong> and the compiled
application is written to <strong>/output/deployments/ROOT.war</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="building-the-production-image">Building the production image</h3>
<div class="paragraph">
<p>This build stage only needs to copy the <strong>/output/wildfly</strong> directory and <strong>/output/deployments/ROOT.war</strong>
file into a new image. The copy operations comprise most of our production image <code>Dockerfile</code>.
It also sets the <code>CMD</code> to start the server when the container image runs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">FROM openjdk:8-jre
COPY /wildfly /wildfly
COPY /deployments /wildfly/standalone/deployments
EXPOSE 8080
CMD ["/wildfly/wildfly/bin/standalone.sh", "-b", "0.0.0.0"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>OpenShift BuildConfig excerpt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">images:
  - from:
      kind: ImageStreamTag
      name: dev-image:latest
    paths:
    - sourcePath: /output/wildfly
      destinationDir: "."
  - from:
      kind: ImageStreamTag
      name: dev-image:latest
    paths:
    - sourcePath: /output/deployments
      destinationDir: "."</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sample-applications">Sample Applications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have developed 3 sample applications to exercise our experimental Galleon S2I image:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/jorgemoralespou/s2i-wildfly-galleon/tree/master/test/test-app">A simple web server app</a>
that serves an HTML and JSP page (derived from the <a href="https://github.com/openshift/openshift-jee-sample">OpenShift sample app</a>).
Its <strong>provisioning.xml</strong> file tells Galleon to provision a WildFly server configured with the <strong>web-server</strong> layer.</p>
</li>
<li>
<p><a href="https://github.com/jorgemoralespou/s2i-wildfly-galleon/tree/master/test/test-app-jaxrs">A toy JSON endpoint app</a>
that depends on jaxrs to expose a simple service that returns some JSON. Its <strong>provisioning.xml</strong>
file tells Galleon to provision a WildFly server configured with the <strong>jaxrs</strong> layer. Some JBoss Module modules,
such as the datatype providers, are useless in this image and can be excluded by Galleon.
This makes the server’s footprint even smaller.</p>
</li>
<li>
<p><a href="https://github.com/jorgemoralespou/s2i-wildfly-galleon/tree/master/test/test-app-postgres">A persistent state demonstration app</a>
that depends on jaxrs, cdi, and jpa to persist user-created tasks (derived from the
 <a href="https://github.com/wildfly/quickstart/tree/master/tasks-rs">tasks-rs WildFly quickstart</a>).
Postgresql is used as the storage backend. This sample app’s <strong>provisioning.xml</strong> file tells Galleon to
provision a WildFly server configured with <strong>cdi</strong>,<strong>jaxrs</strong>,and <strong>jpa</strong> layers.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-the-jaxrs-json-endpoint-sample-application">Running the jaxrs JSON endpoint sample application</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You must have added both the <a href="https://github.com/jorgemoralespou/s2i-wildfly-galleon/blob/master/ose3/galleon-s2i-imagestream.yml">image stream</a>
and <a href="https://github.com/jorgemoralespou/s2i-wildfly-galleon/blob/master/ose3/galleon-s2i-template.yml">template</a> to your OpenShift project.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Click on “Add to Project/Select From Project” then select the template “App built
with Galleon S2I image and optionally connect to DB”.</p>
</li>
<li>
<p>Choose an Image name.</p>
</li>
<li>
<p>The GIT repository is <strong><a href="https://github.com/jorgemoralespou/s2i-wildfly-galleon" class="bare">https://github.com/jorgemoralespou/s2i-wildfly-galleon</a></strong>,
sub directory is <strong>test/test-app-jaxrs</strong>.</p>
</li>
<li>
<p>By default we are using the S2I Image Version <strong>16.0.0.Final</strong>. This image has all
WildFly artifacts present in the local Maven repository, making provisioning of the WildFly server faster.
When using the latest image tag, the artifacts of the latest released WildFly server are retrieved from remote repositories.</p>
</li>
<li>
<p>You can ignore the Postgresql JDBC URL and credentials, they are not used by this sample.</p>
</li>
<li>
<p>Click on Create</p>
</li>
<li>
<p>The development image starts to build. When it is complete, the build of the production
image starts. Once both are built, the 2 deployments are created on the OpenShift cluster
and a route is created through which external clients can access the JSON service.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Only the development image will have an active instance. The production image
is scaled to 0 to save on resources, and the route is balanced to send all traffic
to the development image. If you want to use/test the production image, you’ll need
to change the scaling of both deployments and the weights used in the route.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="adding-features-to-wildfly">Adding Features to WildFly</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Developers frequently need to customize server configurations to match their applications.
For example, we often need to add a JDBC driver and datasource. In the following example,
we extend the server configuration with a PostgreSQL driver and datasource.
Problems we need to solve:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a JBoss Module module for the PostgreSQL driver to the WildFly installation.</p>
</li>
<li>
<p>Add the driver to the <strong>standalone.xml</strong> configuration file.</p>
</li>
<li>
<p>Add a datasource to the <strong>standalone.xml</strong> configuration file. Datasources must be
configured with contextual information. The JDBC url, user, and password are specific
to a deployment and can’t be statically set in the server configuration. We need to adapt the
configuration to the container execution context.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Galleon can help us solve these problems.</p>
</div>
<div class="sect2">
<h3 id="using-the-galleon-api-to-package-a-jdbc-driver-as-a-galleon-feature-pack">Using the Galleon API to package a JDBC driver as a Galleon feature-pack</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The creation of custom Galleon feature-packs is an advanced topic. The API and
overall technique may change in the future.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Galleon has a concept called the <strong>feature-pack</strong>. The WildFly feature-pack is retrieved
when installation occurs. A feature-pack (a zip file) contains features, configurations,
layers, and content such as modules and scripts. Features are used to assemble a WildFly
configuration. We have been using the Galleon FeaturePack Creator API to build a
<a href="https://github.com/jfdenise/galleon-openshift/tree/master/PostGreDriver">PostgreSQL
feature-pack</a> that extends the standalone.xml configuration with a driver and contains the
postgresql driver jar file packaged as a JBoss Module module.</p>
</div>
<div class="paragraph">
<p>This feature-pack can then be installed on top of an existing WildFly installation to
provision the PostgreSQL driver configuration and module. Once the feature-pack is
installed, the WildFly server has the plumbing it needs to connect to a PostgreSQL
server. We’ve solved problems 1) and 2), above.</p>
</div>
</div>
<div class="sect2">
<h3 id="evolving-provisioning-xml-with-the-postgresql-feature-pack-and-datasource">Evolving provisioning.xml with the PostgreSQL feature-pack and datasource</h3>
<div class="paragraph">
<p>As we saw earlier, Galleon allows you to describe the content of an installation
in an XML file, called <strong>provisioning.xml</strong> by convention. We are going to evolve this
file to describe both the server and the driver to install. In addition, we extend
the standalone configuration with a datasource.
<a href="https://github.com/jorgemoralespou/s2i-wildfly-galleon/blob/master/test/test-app-postgres/provisioning.xml">The resulting <strong>provisioning.xml</strong></a>
file contains a complete description of the server installation. We use environment
variables to represent the JDBC URL, user, and password so they can be resolved for
each running instance of the container.</p>
</div>
</div>
<div class="sect2">
<h3 id="postgresql-feature-pack-installation-inside-s2i-image">Postgresql feature-pack installation inside S2I image</h3>
<div class="paragraph">
<p>The Postgresql feature-pack was built for the purposes of this demonstration.
It is not present in public Maven repositories. You can fetch it from <a href="https://github.com/jfdenise/galleon-openshift/releases">this location</a>,
then install it in a local Maven repository. In order to inform S2I assembly that
some feature-packs must be downloaded and installed locally, the file <strong>local-galleon-feature-packs.txt</strong>
must be present at the root of your project.</p>
</div>
<div class="paragraph">
<p>Each desired feature-pack is specified with two lines in this file, a line for the
feature-pack URL followed by a line naming the path inside the local Maven repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">https://github.com/jfdenise/galleon-openshift/releases/download/1.0/postgresql-1.0.zip
org/jboss/galleon/demo/postgresql/1.0/</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="running-the-postgresql-sample-application">Running the postgresql sample application</h3>
<div class="paragraph">
<p>Before these steps, you must deploy a PostgreSQL server in your project and create a database on it.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Click on “Add to Project/Select From Project” then select the template “App built with Galleon S2I image and optionally connect to DB”.</p>
</li>
<li>
<p>Choose an Image name.</p>
</li>
<li>
<p>The GIT repository is <strong><a href="https://github.com/jorgemoralespou/s2i-wildfly-galleon" class="bare">https://github.com/jorgemoralespou/s2i-wildfly-galleon</a></strong>, sub directory is <strong>test/test-app-postgres</strong>.</p>
</li>
<li>
<p>By default we are using the S2I Image Version <strong>16.0.0.Final</strong>.</p>
</li>
<li>
<p>If needed, replace the host, port and database of the JDBC URL.</p>
</li>
<li>
<p>Set the Postgres user name and password.</p>
</li>
<li>
<p>Click on Create</p>
</li>
<li>
<p>The build of the development image starts. When completed, the build of the production
image starts. Once the two images are built, the deployments are created and a route
added through which you can access the service.</p>
</li>
<li>
<p>To add a new task, open a terminal and run</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -i  -H "Content-Length: 0" -X POST http://&lt;your route hostname&gt;/tasks/title/task1</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reduced-server-footprint">Reduced server footprint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using Galleon layers to provision a WildFly server, the image size as well as
runtime memory consumption varies according to the set of installed features.
Here are the total file sizes and for the servers we have provisioned in this post.
As a reference, a complete WildFly server is around 216MB.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. WildFly server</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Feature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cdi, jaxrs, jpa</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">122 MB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jaxrs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">57 MB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jaxrs with JSON data binding provider only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">49 MB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">web-server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">43 MB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Full server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">216 MB</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Sample memory sizes used by the WildFly server process</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">App</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Features installed (layers)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Actual mem used</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Full server mem used</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PostgreSQL sample app</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">cdi, jaxrs, jpa</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30 MB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">35 MB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jaxrs sample app</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jaxrs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19 MB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">28 MB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jsp sample app</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">web-server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16 MB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">27 MB</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="conclusions">Conclusions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the beauties of cloud platforms is that (ideally) you don’t need to care that
much about the infrastructure that runs your application. As a developer, you focus
on creating your application logic, and then rely on the platform, OpenShift, to keep
it available at all times, providing scalability and failover. Your application
may run on any worker node in the cluster. These worker nodes must download the container images
before running the application. The time it takes to download these images is reduced
by reducing the image sizes, although it’s not the only factor. Intelligent use
of the filesystem layering inside the container image is also key. Nevertheless,
a simple rule still holds: Take only what you need. Removing inessential components
not only speeds things up by making images smaller, it also helps reduce the vulnerability
surface of the image. A bug can’t be exploited if it is not installed.</p>
</div>
<div class="paragraph">
<p>Producing smaller, more focused container images is a step toward a more cloud-ready
WildFly application server, but it’s not the only thing we’re working on. Integrating
with more of the cloud platform’s capabilities will be a topic for a later post.</p>
</div>
<div class="paragraph">
<p>One last remark: everything here described is not part of the project and hence not supported.</p>
</div>
</div>
</div>
  </div>
</div>



  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img class="wf-logo" src="/assets/img/wildfly_icons_one-color-logo.png"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">WildFly is open. All dependencies of this project are available under the <a href='https://www.gnu.org/licenses/old-licenses/lgpl-2.1.en.html' target='_blank'>LGPL 2.1</a> or compatible license.<br/><br/>This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/wildfly/wildfly.org/fork' target='_blank'>fork it</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <strong>Navigation</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="/downloads">Downloads</a></li>
          
            <li><a href="https://docs.wildfly.org">Docs</a></li>
          
            <li><a href="https://github.com/wildfly/wildfly">Github</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <strong>Contribute</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://issues.jboss.org/browse/WFLY">Submit a bug</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/wildfly">Join the forum</a></li>
          
            <li><a href="https://github.com/wildfly/wildfly/fork">Fork WildFly</a></li>
          
            <li><a href="https://twitter.com/WildFlyAS">Follow us</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <strong>Get Help</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://groups.google.com/forum/#!forum/wildfly">Join the forum</a></li>
          
            <li><a href="https://wildfly.zulipchat.com/">Join Zulip Chat</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-6-12 more-links">
        <strong>Find more Red Hat Middleware Community Projects</strong>
        <ul class="footer-links">
          
            <li><a href="https://www.apiman.io/">APIMan</a></li>
          
            <li><a href="http://arquillian.org">Arquillian</a></li>
          
            <li><a href="https://github.com/ansible-middleware/wildfly">Ansible Collection for Wildfly</a></li>
          
            <li><a href="http://byteman.jboss.org/">Byteman</a></li>
          
            <li><a href="http://capedwarf.org/">CapeDwarf</a></li>
          
            <li><a href="https://github.com/alechenninger/chronicler">Chronicler</a></li>
          
            <li><a href="https://github.com/darcy-framework">Darcy</a></li>
          
            <li><a href="http://debezium.io/">Debezium</a></li>
          
            <li><a href="https://www.drools.org/">Drools</a></li>
          
            <li><a href="http://gatein.jboss.org/">GateIn</a></li>
          
            <li><a href="http://www.hawkular.org/">Hawkular</a></li>
          
            <li><a href="http://hawt.io/">Hawtio</a></li>
          
            <li><a href="http://hibernate.org/">Hibernate</a></li>
          
            <li><a href="http://www.infinispan.org/">Infinispan</a></li>
          
            <li><a href="https://developers.redhat.com/products/codeready-studio/overview">CodeReady Studio</a></li>
          
            <li><a href="http://forge.jboss.org/">JBoss Forge</a></li>
          
            <li><a href="https://github.com/jboss-logging">JBoss Logging</a></li>
          
            <li><a href="http://jbossremoting.jboss.org/">JBoss Remoting</a></li>
          
            <li><a href="https://www.jbpm.org/">jBPM</a></li>
          
            <li><a href="https://jsfunit.jboss.org/">JSFUnit</a></li>
          
            <li><a href="https://www.keycloak.org/">Keycloak</a></li>
          
            <li><a href="http://modcluster.io/">Mod Cluster</a></li>
          
            <li><a href="http://modeshape.jboss.org/">ModeShape</a></li>
          
            <li><a href="https://www.optaplanner.org/">OptaPlanner</a></li>
          
            <li><a href="https://quarkus.io/">Quarkus</a></li>
          
            <li><a href="http://resteasy.jboss.org/">RESTEasy</a></li>
          
            <li><a href="https://riftsaw.jboss.org/">Riftsaw</a></li>
          
            <li><a href="http://savara.jboss.org/">Savara</a></li>
          
            <li><a href="https://weld.cdi-spec.org/">Weld</a></li>
          
            <li><a href="http://arquillian.org/">Shrinkwrap</a></li>
          
            <li><a href="http://snowdrop.jboss.org/">Snowdrop</a></li>
          
            <li><a href="https://switchyard.jboss.org/">Switchyard</a></li>
          
            <li><a href="https://tattletale.jboss.org/">Tattletale</a></li>
          
            <li><a href="http://teiid.jboss.org/">Teiid</a></li>
          
            <li><a href="https://wildfly-security.github.io/wildfly-elytron/">WildFly Elytron</a></li>
          
            <li><a href="https://thorntail.io/">Thorntail</a></li>
          
            <li><a href="http://wise.jboss.org/">Wise</a></li>
          
            <li><a href="https://xnio.jboss.org/">XNIO</a></li>
          
        </ul>
      </div>
    
  </div>
</div>
  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/img/redhat_reversed.svg"></a>
    </span>
  </div>
</div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/random-color-picker.js"></script>
  <script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
  </script>
</body>

</html>
